# Change Log

## [2.4.1](https://github.com/DataONEorg/d1_python/tree/2.4.1) (2017-12-14)
[Full Changelog](https://github.com/DataONEorg/d1_python/compare/2.4.0...2.4.1)

* GMN
  * Add XML Schema (XSD) validation of incoming Science Metadata documents
    * Applies to calls to MNStorage.create() and MNStorage.update()
    * Controlled by new SCIMETA_VALIDATION_* settings
  * Update jQuery UI to latest and switch from static to hotlinked
  * Fix mistake in cron setup instructions
  * Fix bug that prevented process_refresh_queue from running
  * Improve error handling and logging in bulk importer

* d1_common
  * Add new package for validating Science Metadata
    * The required schemas are included in the package
  * Improve error handling in multiprocessed iterators
  * Update all dependencies to current as of 2017-12-06
  * Misc refactoring

* Tests and test framework
  * Misc smaller test framework improvements
  * Add basic test for GMN home/status page

* Misc  
  * Remove accidentally added duplicates

## [2.4.0](https://github.com/DataONEorg/d1_python/tree/2.4.0) (2017-11-16)
[Full Changelog](https://github.com/DataONEorg/d1_python/compare/2.3.8...2.4.0)

* GMN
  * Fix ServiceFailure caused by some `listObjects()` and `getLogRecords()` slice requests
  * Fix datetimes in DataONE types sometimes returned as naive instead of in the UTC timezone
  * Add support for returning BagIt zip archives from `getPackage()`
    * BagIt objects are generated directly as streams, so arbitrarily sized BagIt archives can be requested and latency is the same as for regular `get()`  
  * Reverse the ordering of `ObjectList` (`listObjects()`) and `Log` (`getLogRecords()`)
    * Now ordered by modified timestamp, ascending, then identifier, ascending
  * Add limit to the maximum number of items that can be returned in a single slice
    * Adjustable via new `MAX_SLICE_ITEMS` setting, 5000 by default
  * Add fallback to default settings
    * Allows new settings to be added without requiring admins to add the new settings into their local settings.py after GMN upgrade
  * Add support for API calls without HTTP User Agent header in GMN
    * Such calls may be generated by custom, "one-off" clients
  * Fixes related to `create()` and `update()` of resource maps and their aggregated objects
    * "block" and "open" modes implemented as described in `RESOURCE_MAP_CREATE` in `settings_template.py`
    * Allow multiple Resource Maps to aggregate the same PID and each other
    * Allow Resource Maps to aggregate non-local and possibly non-existing objects
  * Rework internal representation and handling of revision chains
  * Update bulk importer for handling of out-of-order revisions
  * Refactoring
    * Split up input validation related functionality
    * identifier related functionality
    * Misc

* d1_common
  * Add AccessPolicyWrapper, a wrapper for the AccessPolicy DataONE type adds type specific and intuitive methods directly on the object
    * Add SimpleXMLWrapper, similar functionality for XML
    * These abstract away the details of the types and provide for concise and intuitive code
    * We plan on implementing such wrappers for all relevant types
  * Add new subpackage for generators
    * string generator
    * file contents generator
  * Add module for generating and validating BagIt streams
  * Add utilities for basic XML parsing
  * Improve utilities for comparing and normalizing XML
  * New date-time functions to better handle timezones

* d1_client
  * Improve error handling in multiprocessed iterators

* Test framework
  * Add support for running tests in parallel with `pytest.xdist`
    * Run of test set, currently around 1100 tests, reduced from 7 to 2 min on dev machine
    * Each worker runs against a separate copy of the GMN database, instantiated from shared template
  * Add context managers for setting the CRUD whitelist
  * Add module that calls DataONE APIs in GMN without using PyXB
    * Gives the ability to generate and check response to invalid requests, such as requests with incorrectly formatted URLs, multipart documents, and DataONE types  
  * Add ability to skip recently passed tests
    * Controlled with `--skip` and related test args
    * Default is to not skip
  * Speed up slice tests
  * Better support for timezones in date_time instance generator
  * Add misc functions for working with random lists in instance generator
  * Fix "flaky" test
    * Failed on some combinations of values in the underlying randomly generated type
  * Misc other smaller test framework improvements

* Misc
  * Add around 300 tests since 2.3.8.
  * Update dependencies to current as of 2017-11-16
  * Refactoring:
    * Better timezone support throughout d1_python
    * Misc

## [2.3.8](https://github.com/DataONEorg/d1_python/tree/2.3.8) (2017-10-20)
[Full Changelog](https://github.com/DataONEorg/d1_python/compare/2.3.6...2.3.8)

* Update all dependencies to current versions as of 2017-10-20
* GMN:
  * Add support for storing partial and out-of-order revision chains
    * Automatically combine chain fragments that are found to be part of the
    same chain
    * Tests for various revision and SID related corner cases
  * Add migrations to latest db  
  * Improve progress information in management commands
  * Add diagnostics management command to migrate and repair revision chains
  * Add support for general migrations to bulk importer
  * Remove old migrate_v1_to_v2 command
  * Update database test fixtures and sample docs
* Add misc methods, docstrings and tests to d1_common access_policy module
* Update PyXB bindings to PyXB 1.2.6 and update generator script
* Add multiprocessed log record iterator
* Refactor multiprocessed iterators to improve reliability
* Add API v1.2 MN method wrappers (view and package methods)

## [2.3.6](https://github.com/DataONEorg/d1_python/tree/2.3.6) (2017-08-24)
[Full Changelog](https://github.com/DataONEorg/d1_python/compare/2.3.5...2.3.6)

* Update all dependencies to current versions as of 2017-08-24
* GMN:
  * Add extended listObjects() API
      * Fast method for retrieving large number of selected sysmeta values
      * Returns JSON
      * Quickly generated and parsed
      * No schema
      * Minimal document size
      * Part of a new API class, "ext", which will holds GMN specific APIs
  * Optimize slicing / paging of multi-page result sets
  * Add support for proxied objects in bulk importer
  * Add support for rejecting replication requests for non-public objects
  * Add Proxy, Obsoletes, ObsoletedBy and SeriesId to the custom headers returned by most D1 API methods
    * Proxy header allows clients to determine if an object is proxied and, if so, where the original object resides
    * Obsoletes, ObsoletedBy headers allow clients to determine if object is part of a revision chain
  * Keep track of ownership and versioning of sciobj filesystem store
  * Check every minute instead of every hour for new replication and sysmeta refresh tasks
  * Ongoing refactoring of diagnostics
* Other:
  * Add support for disabling timeout in d1_client by passing timeout=None, 0 or 0.0
* Testing:
  * Add various small unit test improvements
  * Add automatic migration of test database
  * Update samples
  * Ensure that files deleted after previous build are not included in later releases


## [2.3.5](https://github.com/DataONEorg/d1_python/tree/2.3.5) (2017-08-08)
[Full Changelog](https://github.com/DataONEorg/d1_python/compare/2.3.4...2.3.5)

* Update all dependencies to current versions as of 2017-08-07

* Add general bulk importer management command
  * Allows upgrading from any earlier version of GMN or other MN stack

* Add shared module for handling obsolescence chains / revisions
  * `d1_common/revision.py`

* Rename methods for creating missing directory names
  * `d1_common/util.py`

* Add default page size of 100 records for getLogRecords()
  * `d1_common/const.py`

* Expose a ".total" attribute in iterators
  * Clients can read the value from .total to keep track of progress. Earlier, clients had to perform a separate query using filter parameters matching those used by the iterator. There was also a potential race, in that the total could change between query by the iterator and by the client.

* Change iterator arguments:
  * ObjectListIterator: listObjects_args_dict -> list_objects_args
  * LogRecordIterator: getLogRecords_dict -> get_log_records_arg_dict

* Add get_and_save() wrapper for MNRead.get()
  * This is a convenience method added because correctly saving the result
from get() to a file is a bit tricky, while it is also the most common
use of get().
  * Add option to create missing directories for MNRead.get_and_save()

* Add section in README.md about db fixtures for GMN, how they're used, how to generate them
  * Improve procedure for regenerating db fixture

* Add mock API handlers
  * MNCore.getCapabilities()
  * CNCore.listNodes()

* Fix bug: SID did not resolve correctly
  * Add tests for SID resolve

* Update default User-Agent to DataONE_Python/x.y.z +http://dataone.org/

* Add misc type related utilities to d1_common
    * `d1_common/type_conversions.py`, etc.

* Add support for v2 CNRead.synchronize()

* Add description on how to use stream=True with MNRead.get()

* Add handling of db where migrations are out of sync in fixture generator

* Add cleardb diag management command
    * Remove cleardb from the diags page
    * Start code for other "diag" management commands

* Improve the way that chains are represented in the db
    * Less code and faster SID related queries

* Update revision change related model name
    After earlier modifications in how the chains are represented, the old
names were misleading.

* Add SID filtering support
    * Add support for passing SID as the getLogRecords() idFilter and listObjects() identifier args.
    * Note: We don't resolve SIDs for v1, so the v1 pidFilter argument cannot take a
SID.
    * Add tests for SID filtering

* Fix bug: Unable to run management commands

* Update node registration doc to reflects updated manage.py commands

* Add script that checks scimeta indexing

* Misc refactoring and internal improvements  
