name: DataONE Python Stack CI
on: push

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      IS_CI: 1
      DJANGO_SETTINGS_MODULE: d1_gmn.settings_test
      PYTHONPATH: ${{ github.workspace }}

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: github_actions
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
          architecture: x64

      - name: Install packaged deps
        run: |
          sudo apt-get install --yes \
            gir1.2-gtk-3.0 \
            libffi-dev \
            libgirepository1.0-dev \
            librsync-dev \
            libsmbclient-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            openssl \
            postgresql-12 \
            postgresql-client-12 \
            python3-dev \
            python3-gi \
            python3-gi-cairo

      - name: Start Postgres
        run: |
          sudo pg_ctlcluster 12 main start

      - name: Prepare Python env
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r ./requirements.txt

      - name: Dump OS environment (for troubleshooting)
        run: |
          pwd
          ls -l
          python --version

      - name: Prepare d1_python environment
        run: |
          python ./dev_tools/src/d1_dev/setup-all.py --root . develop
          python ./dev_tools/src/d1_dev/syspath.py

      - name: Dump Python environment (for troubleshooting)
        run: |
          # python -m pip freeze
          python -m pip check || true

      - name: Create GMN database from fixture
        run: |
          python ./gmn/src/d1_gmn/tests/mk_db_template.py

      - name: Run tests
        run: |
          # Run tests in parallel, using as many threads as are supported by Actions
          # pytest -n auto --cov-config .coveragerc --cov-report=term --cov-report=xml \
          # ./gmn/src/d1_gmn/tests/test_sysmeta_extract.py -k 1010 \
          # --cov=. \
          # --cov-config=tox.ini \
          # --cov-config=coverage.cfg --cov-report=term --cov-report=xml \

      - name: Submit results to Coveralls.io
        run: |
          # coveralls
