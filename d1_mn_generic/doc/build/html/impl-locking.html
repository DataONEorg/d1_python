
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PID level locking &mdash; v1.0.0</title>
    
    <link rel="stylesheet" href="_static/dataone.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="top" title="v1.0.0" href="index.html" />
    <link rel="up" title="Implementation" href="impl.html" />
    <link rel="next" title="Automatically generated documentation" href="generated.html" />
    <link rel="prev" title="Implementation" href="impl.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_dataone.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="generated.html" title="Automatically generated documentation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="impl.html" title="Implementation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html"></a> &raquo;</li>
          <li><a href="impl.html" accesskey="U">Implementation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pid-level-locking">
<h1>PID level locking<a class="headerlink" href="#pid-level-locking" title="Permalink to this headline">¶</a></h1>
<p>The PID level locking is thread based.</p>
<p>Disadvantages:</p>
<ul class="simple">
<li>Apache must be configured to use a single process with multiple threads. This
configuration is server wide.</li>
<li>If multiple processes are used, the PID locking will fail silently. The errors
caused by this would not be easily reproducible and would include random
corruption of system metadata, crashes and incorrect data returned.</li>
</ul>
<p>Advantages:</p>
<ul class="simple">
<li>As the locks are held in memory, this locking method is fast.</li>
<li>There is no need to remove potential residual locks at startup.</li>
</ul>
<p>Notes:</p>
<ul class="simple">
<li>The method uses a dictionary of locking objects. At the beginning and end of
each view, the view briefly holds an exclusive lock on the dictionary itself.
While the main section of the view is running, it holds a read or write lock
on the PID it operates on. These locks are stored in the dictionary. The
locking objects serialize the views in such a way that all methods that read
information from a given PID can run concurrently while writing blocks access
to all other readers and writers.</li>
<li>This locking method serializes calls instead of returning &#8220;Retry&#8221; exceptions.</li>
</ul>
<p>The potential issues are:</p>
<ul class="simple">
<li>Performance issues in Apache related to running a single process with multiple
threads.</li>
<li>Inability to change Apache configuration because Apache is running other web
apps.</li>
</ul>
<p>Note: Under Windows, Apache uses a multi-process manager (MPM) called &#8220;winnt&#8221;.
This MPM always uses a single process with multiple threads.</p>
<p>If another type of locking must be implemented, some issues to consider are:</p>
<p>When storing locks in the database:</p>
<ul class="simple">
<li>Does not implicitly support serialization of calls; it becomes more natural to
raise &#8220;Retry&#8221; exceptions.</li>
<li>Becomes harder to support multiple concurrent readers.</li>
<li>The transaction management middleware layer in Django wraps updates performed
by a view in a transaction. When storing locks in the database, updates to the
locks must become visible to other views before they start their own
processing, which makes it incompatible with the transaction middleware.</li>
</ul>
<div class="section" id="optimistic-locking">
<h2>Optimistic locking<a class="headerlink" href="#optimistic-locking" title="Permalink to this headline">¶</a></h2>
<p>It may be that an optimistic locking scheme is best for GMN, as there will be
low contention during regular operation.</p>
<p>Potential issues:</p>
<ul class="simple">
<li>Optimistic locking is mainly used where the result of processing is store in
an atomic operation. When operating on data both on the file system and in the
database, updates can not be atomic, so each view must be aware that it may be
processing information that is concurrently being updated and must fail
gracefully if the data is not what is expected.</li>
<li>Optimistic locking causes &#8220;Retry&#8221; exceptions instead of serialization.</li>
</ul>
</div>
<div class="section" id="django-and-multi-threading">
<h2>Django and multi-threading<a class="headerlink" href="#django-and-multi-threading" title="Permalink to this headline">¶</a></h2>
<p>Django was not initially written to support multi-threading. The only supported
mode when running Django under Apache was the &#8220;prefork&#8221; MPM, which runs each
Django instance in a separate process. There is much discussion online about
issues related to Django and multi-threading. However, almost all of these
relate to versions of Django prior to version 1.0. Support for multi-threading
was constantly being worked on and was mostly resolved as of version 1.0. As of
version 1.3, there are two known multi-threading issues in Django itself but
these refer to corner cases in poorly written apps.</p>
</div>
<div class="section" id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/stdbrouw/django-locking">https://github.com/stdbrouw/django-locking</a></p>
<p>Python native: multiprocessing.managers.SyncManager</p>
<p><a class="reference external" href="http://stackoverflow.com/questions/320096/django-how-can-i-protect-against-concurrent-modification-of-data-base-entries">http://stackoverflow.com/questions/320096/django-how-can-i-protect-against-concurrent-modification-of-data-base-entries</a></p>
<p><a class="reference external" href="https://groups.google.com/group/django-developers/browse_frm/thread/905f79e350525c95/dfed56f8ed65aed2">https://groups.google.com/group/django-developers/browse_frm/thread/905f79e350525c95/dfed56f8ed65aed2</a></p>
<p><a class="reference external" href="http://groups.google.com/group/django-users/browse_thread/thread/e882e25271e667d9/95d52fc57b82e189">http://groups.google.com/group/django-users/browse_thread/thread/e882e25271e667d9/95d52fc57b82e189</a></p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Django_%28web_framework%29#Server_arrangements">http://en.wikipedia.org/wiki/Django_%28web_framework%29#Server_arrangements</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/dataone_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PID level locking</a><ul>
<li><a class="reference internal" href="#optimistic-locking">Optimistic locking</a></li>
<li><a class="reference internal" href="#django-and-multi-threading">Django and multi-threading</a></li>
<li><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation Overview</a><ul>
  <li><a href="impl.html">Implementation</a><ul>
      <li>Previous: <a href="impl.html" title="previous chapter">Implementation</a></li>
      <li>Next: <a href="generated.html" title="next chapter">Automatically generated documentation</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy; Copyright <a href="http:/www.dataone.org">2010-2012 Participating institutions in DataONE</a>.
        [ <a href="_sources/impl-locking.txt"
               rel="nofollow">Page Source</a> | 
          <a href='https://redmine.dataone.org/projects/d1/repository/changes/documents/Projects/cicore/architecture/api-documentation/source/impl-locking.txt'
            rel="nofollow">Revision History</a> ]&nbsp;&nbsp;
    </div>
    <!--
    <hr />
     <div id="HCB_comment_box"><a href="http://www.htmlcommentbox.com">HTML Comment Box</a> is loading comments...</div>
     <link rel="stylesheet" type="text/css" href="_static/skin.css" />
     <script type="text/javascript" language="javascript" id="hcb"> 
     /*<! -*/ 
     (function()
     {s=document.createElement("script");
     s.setAttribute("type","text/javascript");
     s.setAttribute("src", "http://www.htmlcommentbox.com/jread?page="+escape((typeof hcb_user !== "undefined" && hcb_user.PAGE)||(""+window.location)).replace("+","%2B")+"&mod=%241%24wq1rdBcg%24Gg8J5iYSHJWwAJtlYu/yU."+"&opts=21407&num=10");
     if (typeof s!="undefined") document.getElementsByTagName("head")[0].appendChild(s);})();
      /* ->*/ 
     </script>
   -->
  </body>
</html>