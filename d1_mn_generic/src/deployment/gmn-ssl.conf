<IfModule mod_ssl.c>

    WSGIPythonHome /var/local/dataone/gmn

    <VirtualHost *:443>
        ServerAdmin webmaster@localhost

        # These settings are required for GMN to correctly handle the DataONE
        # REST calls. See for more information:
        # http://mule1.dataone.org/ArchitectureDocs-current/notes/ApacheConfiguration.html#configuration
        AllowEncodedSlashes NoDecode
        AcceptPathInfo On

        DocumentRoot /var/www

        <Directory />
            # Disable .htaccess files.
            AllowOverride None
            Require all denied
        </Directory>

        <Directory /var/www/>
            Options Indexes FollowSymLinks MultiViews
            AllowOverride None
            Require all denied
        </Directory>

        # Logging
        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        LogLevel info
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # Enable SSL for this virtual host.
        SSLEngine on

        # Server side certificate.
        SSLCertificateFile    /var/local/dataone/certs/server/server_cert.pem
        SSLCertificateKeyFile /var/local/dataone/certs/server/server_key_nopassword.pem

        # Server Certificate Chain
        #SSLCertificateChainFile /etc/apache2/ssl.crt/server-ca.crt

        # GMN standard location for optional certificate chain file.
        #SSLCertificateChainFile /var/local/dataone/certs/server/server_intermediate.pem

        # Certificate Authority (CA)
        # GMN trusts only a few specific CAs, so a directory separate from the
        # one holding the CA certificates trusted by the OS is used.
        SSLCACertificatePath /var/local/dataone/certs/ca
        SSLCACertificateFile /var/local/dataone/certs/ca/cilogon_dataone_ca_chain.pem

        #   Certificate Revocation Lists (CRL)
        #SSLCARevocationPath /etc/apache2/ssl.crl/
        #SSLCARevocationFile /etc/apache2/ssl.crl/ca-bundle.crl

        # Client Authentication (Type)
        # GMN accepts SSL/TLS connections without client side certificates.
        # These are are treated as anonymous connections. The "optional" setting
        # for SSLVerifyClient requires any provided client side certificate to
        # be issued by a trusted CA but allows it to be left out altogether.
        SSLVerifyClient optional
        SSLVerifyDepth 10

        # SSL Engine Options
        # GMN needs to have access to the submitted client side certificate.
        # Configure mod_ssl to forward the certificate to the GMN WSGI handler
        # in an environment variable.
        <FilesMatch "\.(wsgi)$">
            SSLOptions +ExportCertData
        </FilesMatch>

        # SSL Protocol Adjustments
        BrowserMatch "MSIE [2-6]" \
            nokeepalive ssl-unclean-shutdown \
            downgrade-1.0 force-response-1.0
        # MSIE 7 and newer should be able to use keepalive
        BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

        # WSGI
        WSGIScriptAlias /mn /var/local/dataone/gmn/lib/python2.7/site-packages/service/gmn.wsgi
        WSGIDaemonProcess gmn user=gmn processes=2 threads=25 python-path=/var/local/dataone:/var/local/dataone/gmn/lib/python2.7/site-packages
        WSGIProcessGroup gmn

        <Directory /var/local/dataone/gmn/lib/python2.7/site-packages/service>
            WSGIApplicationGroup %{GLOBAL}
            Require all granted
        </Directory>

        # Prevent well-behaved web crawlers from indexing public objects.
        Alias /robots.txt /var/local/dataone/gmn/lib/python2.7/site-packages/service/mn/static/robots.txt

        # Serve static files directly.
        Alias /static/ /var/local/dataone/gmn/lib/python2.7/site-packages/service/mn/static/
    </VirtualHost>
</IfModule>
